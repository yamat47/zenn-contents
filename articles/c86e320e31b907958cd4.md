---
title: "ActiveModelã®ãƒãƒªãƒ‡ãƒ¼ã‚¿ã§JSONå‹ã®ã‚«ãƒ©ãƒ ã‚’æ¤œè¨¼ã™ã‚‹"
emoji: "ğŸ¥®"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rails", "json", "validation"]
published: true
---

JSON å‹ã®ã‚«ãƒ©ãƒ ã£ã¦ä½¿ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ
----

Rails ã§ã¯ã„ã¤ã‹ã‚‰ã‹ JSON å‹ãªã‚«ãƒ©ãƒ ã‚’æ‰±ã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ãƒ†ãƒ¼ãƒ–ãƒ«ã®é–¢é€£ã™ã‚‹æƒ…å ±ã ã‘ã©ã‚ã–ã‚ã–åˆ¥ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã¤ãã‚‹ã»ã©ã®ã‚‚ã®ã§ã‚‚ãªã„...ã¨ã„ã£ãŸæƒ…å ±ã‚’æ‰±ã†ã¨ãã«ä½¿ã£ã¦ã„ã‚‹æ–¹ã‚‚å¤šã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ãŸã ã“ã® JSON å‹ã®ã‚«ãƒ©ãƒ ã€ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ã‚’ã™ã‚‹ã®ãŒå°‘ã—é›£ã—ã„ã§ã™ã€‚
é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ãˆã‚‹ã¨ã¯ã„ã£ã¦ã‚‚æ‰€è©®ã¯ JSONã€‚
åƒ•ã‚‰ãŒæ…£ã‚Œè¦ªã—ã‚“ã  `ActiveModel` ã®ãƒ¬ãƒ¼ãƒ«ã«æ²¿ã£ã¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‹ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ãªã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“...ã€‚

ç´ ç›´ã«è€ƒãˆã‚‹ã¨ã“ã†ã„ã†æ¤œè¨¼æ–¹æ³•ã«ãªã‚‹ã¯ãš
----

JSON ã¯ [JSON Schema](https://json-schema.org/) ã«ã‚ˆã£ã¦å®šã‚ã‚‰ã‚ŒãŸæ›¸å¼ã‚’ç”¨ã„ã¦å½¢å¼ã‚’å®šã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
å®šã‚ã‚‰ã‚Œã‚‹å½¢å¼ã¨ã¯ä¾‹ãˆã°ã€Œ`name` ã¨ `title` ã‚’ã‚­ãƒ¼ã«æŒã¤ãƒãƒƒã‚·ãƒ¥ï¼ˆã®ã‚ˆã†ãªã‚‚ã®ï¼‰ã€ã€Œæ•°å€¤ãŒå…¥ã£ãŸé…åˆ—ã€ã¨ã„ã£ãŸã‚‚ã®ã§ã™ã€‚
ç´ ç›´ã«è€ƒãˆã‚Œã°ã€Rails ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã‚‚è¨±å®¹ã™ã‚‹ JSON ã®å½¢å¼ã‚’äºˆã‚å®šç¾©ã—ã¦ãŠãã€ãã®å½¢å¼ã«æ²¿ã£ã¦ã„ã‚‹ã‹æ¤œè¨¼ã™ã‚Œã°ã‚ˆã•ãã†ã§ã™ã€‚

ã“ã®æ‰‹æ³•ã§ã„ãå ´åˆã€ä¾‹ãˆã°ä»¥ä¸‹ã® Gem ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã„ã‚‹äººãŒå¤šã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

* [ruby-json-schema/json-schema](https://github.com/ruby-json-schema/json-schema), [davishmcclurg/json_schemer](https://github.com/davishmcclurg/json_schemer): JSON ã®å€¤ã®æ¤œè¨¼æ–¹æ³•ã‚’æä¾›ã™ã‚‹ Gemã€‚
* [mirego/activerecord_json_validator](https://github.com/mirego/activerecord_json_validator): JSON ã®å½¢å¼ã®æ¤œè¨¼ã‚’ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã™ã‚‹ Gemã€‚

ã—ã‹ã—ã“ã‚Œã¯ Rails ãŒç”¨æ„ã—ã¦ã„ã‚‹æ¤œè¨¼æ–¹æ³•ã¨ã¯å…¨ãç•°ãªã‚‹ã€Rails ã®ãƒ¬ãƒ¼ãƒ«ã‹ã‚‰å¤–ã‚ŒãŸæ¤œè¨¼æ–¹æ³•ã§ã™ã€‚
ãªã‚‹ã¹ãã‚·ãƒ³ãƒ—ãƒ«ã«ã€ã§ã‚‚ `ActiveModel` ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦æ¤œè¨¼ã‚’ã—ã‚ˆã†ã¨ã„ã†ã®ãŒã“ã®è¨˜äº‹ã®ãƒ†ãƒ¼ãƒã§ã™ã€‚

å‹•ä½œç’°å¢ƒ
----

ã“ã‚Œã‹ã‚‰å‡ºã¦ãã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§æ¤œè¨¼ã‚’ã—ã¾ã—ãŸã€‚

* Ruby: 2.7.1
* Rails: 6.0.3.3

ãŸã ã©ã®ã‚³ãƒ¼ãƒ‰ã‚‚æœ€è¿‘å‡ºã¦ããŸæ–°ã—ã„æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€ã‚ã‚‹ç¨‹åº¦æ˜”ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ã§ã¯ãã®ã¾ã¾å‹•ãã‹ã¨æ€ã„ã¾ã™ã€‚
ï¼ˆå½“ç„¶ã§ã™ãŒã©ã‚“ã©ã‚“ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸Šã’ã¦ã„ãã¾ã—ã‚‡ã†ã­ã€[kamipo ã•ã‚“ã‚‚ã“ã†ä»°ã£ã¦ã¾ã™ã—ï¼](https://twitter.com/kamipo/status/1272651740941152256?s=21)ï¼‰

å ´é¢è¨­å®š
----

ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ãã‚Œãã‚Œåˆ¥ã‚«ãƒ©ãƒ ã«ã™ã‚‹ã®ã§ã¯ãªãã¾ã¨ã‚ã¦ JSON å‹ã§å®šç¾©ã™ã‚‹ã€ã¨ã„ã†è¨­å®šã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚
ä½•ã‚‚ã—ãªã„ã¨ã©ã‚“ã©ã‚“ `users` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå·¨å¤§åŒ–ã—ã¦ã„ã£ã¦ã—ã¾ã†ã®ã‚’ JSON å‹ã«ã™ã‚‹ã“ã¨ã§ã¡ã‚‡ã£ã¨ã§ã‚‚é…ã‚‰ã›ã‚ˆã†ã€ã¨ã„ã£ãŸæ„å›³ã§ã™ã€‚

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒã“ã¡ã‚‰ã€‚
JSON ã«å«ã¾ã‚Œã‚‹å€¤ã®åˆ¶ç´„æ¡ä»¶ã‚‚ç°¡å˜ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

**`db/migrate/20200919051438_create_users.rb`**

```ruby
# profileã‚«ãƒ©ãƒ ã«JSONå‹ã‚’æŒ‡å®šã€‚
#
# å«ã‚ã‚‹æƒ…å ±:
#   nickname: 4æ–‡å­—ä»¥ä¸Š12æ–‡å­—ä»¥ä¸‹ã®æ–‡å­—åˆ—
#   editor: 'vim' OR 'emacs'
#   website: URLå½¢å¼ã®æ–‡å­—åˆ—
#
class CreateUsers < ActiveRecord::Migration[6.0]
  def change
    create_table :users do |t|
      t.json :profile, null: false
    end
  end
end
```

æ„å›³ã—ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‹ã‹ã£ã¦ã„ã‚‹ã‹ã©ã†ã‹åˆ¤å®šã™ã‚‹ãŸã‚ã« RSpec ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ãŠãã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚’ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã« [tomykaira/rspec-parameterized](https://github.com/tomykaira/rspec-parameterized) ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

**`spec/models/user_spec.rb`**

```ruby
require 'rails_helper'

RSpec.describe User do
  describe 'profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³' do
    context 'profileãŒä¸æ­£ãªå€¤ã®ã¨ã' do
      where(:profile) do
        [
          nil,
          {},
          { nickname: nil, editor: 'vim', website: 'https://github.com/yamat47' }, # nicknameãŒnil
          { nickname: 'yamat47', editor: nil, website: 'https://github.com/yamat47' }, # editorãŒnil
          { nickname: 'yamat47', editor: 'vim', website: nil }, # websiteãŒnil
          { nickname: 'dog', editor: 'vim', website: 'https://github.com/yamat47' }, # nicknameãŒçŸ­ã„
          { nickname: 'superlongnickname', editor: 'vim', website: 'https://github.com/yamat47' }, # nicknameãŒé•·ã„
          { nickname: 'yamat47', editor: 'Visual Studio Code', website: 'https://github.com/yamat47' }, # editorãŒå€™è£œã®ä¸­ã«ãªã„
          { nickname: 'yamat47', editor: 'vim', website: 'htps://github.com/yamat47' }, # websiteã®å½¢å¼ã«æ²¿ã£ã¦ã„ãªã„ï¼ˆhtpsã§å§‹ã¾ã£ã¦ã„ã‚‹ï¼‰
        ]
      end

      with_them do
        it { expect(User.new(profile: profile)).to be_invalid }
      end
    end

    context 'profileãŒæ­£ã—ã„å€¤ã®ã¨ã' do
      where(:profile) do
        [
          { nickname: 'yamat47', editor: 'vim', website: 'https://github.com/yamat47' },
          { nickname: 'yamat47', editor: 'emacs', website: 'https://github.com/yamat47' }
        ]
      end

      with_them do
        it { expect(User.new(profile: profile)).to be_valid }
      end
    end

    context 'profileã«ä½™è¨ˆãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä»˜ã„ã¦ã„ã‚‹ã¨ã' do
      it 'initializeã‚’ã™ã‚‹ã¨ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹' do
        expect { User.new(nickname: 'yamat47', editor: 'vim', website: 'https://github.com/yamat47', birthday: Date.current) }.to raise_error ActiveModel::UnknownAttributeError
      end
    end
  end
end

```

ãƒ”ãƒ¥ã‚¢ãª `ActiveRecord` ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®é™ç•Œ
----

ç´ ã® `ActiveRecord` ã ã¨ JSON ã®ä¸­èº«ã¾ã§ã¯æ¤œè¨¼ã§ããšã€ã§ãã¦ã‚‚å€¤ã®å­˜åœ¨ç¢ºèªãã‚‰ã„ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

**`app/models/user.rb`**

```ruby
class User < ApplicationRecord
  validates :profile, presence: true
end
```

ã“ã®æ™‚ç‚¹ã§ã‚‚ã™ã§ã« `nil` ã‚„ `{}` ãŒæ¸¡ã•ã‚ŒãŸã¨ãã«ã¯ä¸æ­£ãªå€¤ã¨ã—ã¦å¼¾ãã“ã¨ãŒã§ãã¾ã™ã€‚
ã—ã‹ã—ãã‚Œä»¥ä¸Šã®ç´°ã‹ã„æ¤œè¨¼ãŒã§ããªã„ãŸã‚ã€ä¾‹ãˆã°å¿…è¦ãªæƒ…å ±ãŒè¶³ã‚Šã¦ã„ãªãã¦ã‚‚ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¦ã—ã¾ã„ã¾ã™ã€‚

å…ˆã»ã©æ›¸ã„ãŸãƒ†ã‚¹ãƒˆã‚‚ã»ã¨ã‚“ã©ãŒå¤±æ•—ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

```
$ bundle exec rspec spec/models/user_spec.rb
..FFFFFFF...

Failures:

  1) User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>nil, :editor=>"vim", :website=>"https://github.com/yamat47"} is expected to be invalid
     Failure/Error: it { expect(User.new(profile: profile)).to be_invalid }
       expected `#<User id: nil, profile: {"nickname"=>nil, "editor"=>"vim", "website"=>"https://github.com/yamat47"}>.invalid?` to return true, got false
     # ./spec/models/user_spec.rb:21:in `block (5 levels) in <top (required)>'

  2) User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"yamat47", :editor=>nil, :website=>"https://github.com/yamat47"} is expected to be invalid
     Failure/Error: it { expect(User.new(profile: profile)).to be_invalid }
       expected `#<User id: nil, profile: {"nickname"=>"yamat47", "editor"=>nil, "website"=>"https://github.com/yamat47"}>.invalid?` to return true, got false
     # ./spec/models/user_spec.rb:21:in `block (5 levels) in <top (required)>'

  3) User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"yamat47", :editor=>"vim", :website=>nil} is expected to be invalid
     Failure/Error: it { expect(User.new(profile: profile)).to be_invalid }
       expected `#<User id: nil, profile: {"nickname"=>"yamat47", "editor"=>"vim", "website"=>nil}>.invalid?` to return true, got false
     # ./spec/models/user_spec.rb:21:in `block (5 levels) in <top (required)>'

  4) User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"dog", :editor=>"vim", :website=>"https://github.com/yamat47"} is expected to be invalid
     Failure/Error: it { expect(User.new(profile: profile)).to be_invalid }
       expected `#<User id: nil, profile: {"nickname"=>"dog", "editor"=>"vim", "website"=>"https://github.com/yamat47"}>.invalid?` to return true, got false
     # ./spec/models/user_spec.rb:21:in `block (5 levels) in <top (required)>'

  5) User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"superlongnickname", :editor=>"vim", :website=>"https://github.com/yamat47"} is expected to be invalid
     Failure/Error: it { expect(User.new(profile: profile)).to be_invalid }
       expected `#<User id: nil, profile: {"nickname"=>"superlongnickname", "editor"=>"vim", "website"=>"https://github.com/yamat47"}>.invalid?` to return true, got false
     # ./spec/models/user_spec.rb:21:in `block (5 levels) in <top (required)>'

  6) User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"yamat47", :editor=>"Visual Studio Code", :website=>"https://github.com/yamat47"} is expected to be invalid
     Failure/Error: it { expect(User.new(profile: profile)).to be_invalid }
       expected `#<User id: nil, profile: {"nickname"=>"yamat47", "editor"=>"Visual Studio Code", "website"=>"https://github.com/yamat47"}>.invalid?` to return true, got false
     # ./spec/models/user_spec.rb:21:in `block (5 levels) in <top (required)>'

  7) User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"yamat47", :editor=>"vim", :website=>"htps://github.com/yamat47"} is expected to be invalid
     Failure/Error: it { expect(User.new(profile: profile)).to be_invalid }
       expected `#<User id: nil, profile: {"nickname"=>"yamat47", "editor"=>"vim", "website"=>"htps://github.com/yamat47"}>.invalid?` to return true, got false
     # ./spec/models/user_spec.rb:21:in `block (5 levels) in <top (required)>'

Finished in 0.02937 seconds (files took 1.21 seconds to load)
12 examples, 7 failures

Failed examples:

rspec './spec/models/user_spec.rb[1:1:1:3:1]' # User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>nil, :editor=>"vim", :website=>"https://github.com/yamat47"} is expected to be invalid
rspec './spec/models/user_spec.rb[1:1:1:4:1]' # User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"yamat47", :editor=>nil, :website=>"https://github.com/yamat47"} is expected to be invalid
rspec './spec/models/user_spec.rb[1:1:1:5:1]' # User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"yamat47", :editor=>"vim", :website=>nil} is expected to be invalid
rspec './spec/models/user_spec.rb[1:1:1:6:1]' # User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"dog", :editor=>"vim", :website=>"https://github.com/yamat47"} is expected to be invalid
rspec './spec/models/user_spec.rb[1:1:1:7:1]' # User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"superlongnickname", :editor=>"vim", :website=>"https://github.com/yamat47"} is expected to be invalid
rspec './spec/models/user_spec.rb[1:1:1:8:1]' # User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"yamat47", :editor=>"Visual Studio Code", :website=>"https://github.com/yamat47"} is expected to be invalid
rspec './spec/models/user_spec.rb[1:1:1:9:1]' # User profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ profileãŒä¸æ­£ãªå€¤ã®ã¨ã profile: {:nickname=>"yamat47", :editor=>"vim", :website=>"htps://github.com/yamat47"} is expected to be invalid
```

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¨ãã ã‘ `ActiveModel` ã«å¤‰æ›ã‚’ã™ã‚‹
-----

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¨ãã ã‘ JSON å‹ã‚«ãƒ©ãƒ ã®å€¤ã‚’ `ActiveModel` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å¤‰æ›ã™ã‚‹ã¨ã„ã†æ‰‹æ³•ã‚’å–ã‚Šã¾ã—ãŸã€‚
å…·ä½“çš„ã«ã¯æ¬¡ã®ã‚ˆã†ã«è¡Œã„ã¾ã™ã€‚

**`app/models/user.rb`**

```ruby
class User < ApplicationRecord
  validates :profile, presence: true

  validates_with User::ProfileValidator, if: ->(user) { user.profile.present? }
end
```

**`app/validators/user/profile_validator.rb`**

```ruby
class User::ProfileValidator < ActiveModel::Validator
  def validate(record)
    profile = Profile.new(record.profile.symbolize_keys)

    return if profile.valid?

    # profileã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’Userã«ãƒãƒ¼ã‚¸ã™ã‚‹ã€‚
    #
    # Userã«ç›´æ¥å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ©ãƒ ã¨ã‚­ãƒ¼ãŒè¢«ã‚‰ãªã„ã‚ˆã†ã«
    # 'profile_'ä»˜ãã®ã‚­ãƒ¼ã«ã—ã¦ãŠãã€‚
    profile.errors.each do |attribute, message|
      record.errors.add("profile_#{attribute}", message)
    end
  end

  class Profile
    include ActiveModel::Model
    include ActiveModel::Attributes
    include ActiveModel::Validations

    attribute :nickname, :string
    attribute :editor, :string
    attribute :website, :string

    validates :nickname, length: { in: 4..12 }
    validates :editor, inclusion: { in: %w(vim emacs) }
    validates :website, presence: true, url: { allow_blank: true }
  end
end
```

**`app/validators/url_validator.rb`**

```ruby
# å‚è€ƒ: https://coderwall.com/p/ztig5g/validate-urls-in-rails

class UrlValidator < ActiveModel::EachValidator
  def validate_each(record, attribute, value)
    record.errors[attribute] << (options[:message] || "must be a valid URL") unless url_valid?(value)
  end

  # a URL may be technically well-formed but may
  # not actually be valid, so this checks for both.
  def url_valid?(url)
    url = URI.parse(url) rescue false
    url.kind_of?(URI::HTTP) || url.kind_of?(URI::HTTPS)
  end
end
```

ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:

* `User::ProfileValidator` ã‚’ä½œã‚‹ã‹ã©ã†ã‹ã¯å¥½ã¿ã®å•é¡Œã§ã™ãŒã€ã‹ãªã‚Šè¾¼ã¿å…¥ã£ãŸãƒ­ã‚¸ãƒƒã‚¯ã«ãªã‚‹ã®ã§ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚¿ã‚’å®šç¾©ã™ã‚‹ã¨ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ã¯ã‚ˆããªã‚Šã¾ã™ã€‚
* `ActiveModel` ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ©Ÿèƒ½ã‚’ãƒ•ãƒ«ã«ä½¿ãˆã‚‹ãŸã‚ `UrlValidator` ã®ã‚ˆã†ãªè‡ªå‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦æ¤œè¨¼ã‚’ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
* ã‚¨ãƒ©ãƒ¼ã®æƒ…å ±ã¯å…¨ã¦ `User` ã«ã¾ã¨ã‚ã‚‹ã“ã¨ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¿»è¨³ã‚’ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚

ã“ã®ä¿®æ­£ã«ã‚ˆã‚Šæ¤œè¨¼ç”¨ã®ãƒ†ã‚¹ãƒˆã‚‚å…¨ã¦æˆåŠŸã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```
$ bundle exec rspec spec/models/user_spec.rb
............

Finished in 0.04782 seconds (files took 1.78 seconds to load)
12 examples, 0 failures
```

ã¾ã¨ã‚
----

ã†ã¾ãä½¿ãˆãŸã‚‰ä¾¿åˆ©ãª JSON å‹ã‚«ãƒ©ãƒ ã‚’ã‚ˆã‚Š Rails ã®ãƒ¬ãƒ¼ãƒ«ã«ä¹—ã£ã‘ã¦æ‰±ã†ãŸã‚ã®å·¥å¤«ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
æ­£è¦åŒ–ã‚’è€ƒãˆã‚‹ã¨ãªã‹ãªã‹ä½¿ã„ã¥ã‚‰ã„å‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ä½•ã‚‚è€ƒãˆãšã«åˆ¥ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã™ã‚‹å‰ã«ä¸€åº¦ JSON ãŒä½¿ãˆãªã„ã‹è€ƒãˆã¦ã¿ã‚‹ã®ã‚‚ã‚ˆã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

ã‚‚ã— JSON å‹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§ä»–ã®æ–¹æ³•ã‚’ä½¿ã£ã¦ã„ã‚‹æ–¹ãŒã„ã‚Œã°ãœã²æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ï¼

ã¾ãŸä»Šå›ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰ã¯ [yamat47/rails-json-validation](https://github.com/yamat47/rails-json-validation) ã«ã¾ã¨ã‚ã¾ã—ãŸã€‚
å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
