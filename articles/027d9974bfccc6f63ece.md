---
title: "Capistranoã§å‹•çš„ãªå€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã¨ãã¯Procã‚’æ¸¡ãã†"
emoji: "ğŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['Rails', 'Capistrano']
published: true
---

Rails ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã§ä½¿ã‚ã‚Œã‚‹ã“ã¨ã®å¤šã„ Capistranoã€ã“ã‚“ãªæ„Ÿã˜ã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãã¾ã™ã‚ˆã­ï¼š

```ruby:config/deploy.rb
# If the environment differs from the stage name
set :rails_env, 'staging'

# Defaults to :db role
set :migration_role, :db

# Defaults to the primary :db server
set :migration_servers, -> { primary(fetch(:migration_role)) }
```

ï¼ˆ[capistrano/rails](https://github.com/capistrano/rails) ã‹ã‚‰å¼•ç”¨ã—ã¾ã—ãŸï¼‰

ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã«ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ãŒ `#set` ã«ã¯ã‚·ãƒ³ãƒœãƒ«ã‚„æ–‡å­—åˆ—ã ã‘ã§ãªã Proc ã‚’æ¸¡ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
Procã‚’æ¸¡ã—ãŸã¨ãã¯ãã†ã§ãªã„ã¨ãã¨å°‘ã—é•ã†æŒ™å‹•ã«ãªã‚‹ã®ã§æ°—ã‚’ä»˜ã‘ã‚ˆã†ã€ã¨ã„ã†è©±ã§ã™ã€‚

`#set` ã« Proc ä»¥å¤–ã‚’æ¸¡ã—ãŸã¨ãã®æŒ™å‹•
----

```ruby
set :rails_env, 'staging'
set :migration_role, :db
```

ã“ã“ã§ã‚»ãƒƒãƒˆã—ãŸå€¤ã¯ `#fetch` ã‚’å‘¼ã¶ã“ã¨ã§ä»–ã®éƒ¨åˆ†ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ãã®ã¨ãã«è¿”ã£ã¦ãã‚‹å€¤ã¯ `#set` ã«æ¸¡ã—ãŸå€¤ãã®ã‚‚ã®ï¼ˆ`'staging'`ã€`:db`ï¼‰ã§ã™ã€‚

`#set` ã« Proc ã‚’æ¸¡ã—ãŸã¨ãã®æŒ™å‹•
----

```ruby
set :migration_servers, -> { primary(fetch(:migration_role)) }
```

ã“ã“ã§ã¯ `:migration_servers` ã¨ã„ã†ã‚­ãƒ¼ã« `-> { primary(fetch(:migration_role)) }` ã¨ã„ã† Proc ãŒå€¤ã¨ã—ã¦ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

**ã“ã® Proc ã¯ã™ãã«è©•ä¾¡ã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªãã€ã‚­ãƒ¼ãŒ `#fetch` ã•ã‚ŒãŸã¨ãã«åˆã‚ã¦è©•ä¾¡ã•ã‚Œã¾ã™ã€‚**
ãã®ãŸã‚ `:migration_role` ã«å€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã®ãŒå¾Œã«ãªã£ã¦ã‚‚å‚ç…§ã•ã‚Œã¦å‹•ä½œã—ã¾ã™ã€‚

```ruby
set :migration_servers, -> { primary(fetch(:migration_role)) }
set :migration_role, :db

fetch(:migration_servers) # ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§åˆã‚ã¦ Proc ãŒè©•ä¾¡ã•ã‚Œã¦å€¤ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹
```

è©•ä¾¡ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé…ããªã‚‹ã®ã¯ Proc ã ã‹ã‚‰ã§ã™ã€‚
â†“ ã®ä¾‹ã®ã‚ˆã†ã«æ–‡å­—åˆ— & å¼å±•é–‹ã‚’ã—ãŸå ´åˆã¯å…ˆã»ã© `'staging'` ã‚’æ¸¡ã—ãŸã¨ãã¨åŒæ§˜ã«ã™ãã«å€¤ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

```ruby
set :migration_servers, "#{primary(fetch(:migration_role))}" # migration_roleã¯ã¾ã ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ = nilã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹
set :migration_role, :db

fetch(:migration_servers) # set :migration_serversã—ãŸã¨ãã®å€¤ãŒè¿”ã£ã¦ãã‚‹
```

å‹•çš„ãªå€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã¨ãã¯ Proc ã‚’æ¸¡ãã†
---

ä¸Šã®ä¾‹ã®ã‚ˆã†ã«ã€ä»–ã«ã‚»ãƒƒãƒˆã—ãŸå€¤ã‚’ä½¿ã£ã¦å‹•çš„ã«å€¤ã‚’ä½œã‚‹å ´åˆã¯ Proc ã‚’æ¸¡ã™ã¨å®‰å…¨ã§ã™ã€‚
å€¤ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹é †ç•ªã«å¤‰ã«ä¾å­˜ã—ãŸã‚³ãƒ¼ãƒ‰ã«ãªã‚‰ãªã„ã§æ¸ˆã‚€ãŸã‚ã§ã™ã€‚

ä¾‹ãˆã° [capistrano/rbenv](https://github.com/capistrano/rbenv) ã® README ã«ã¯ã“ã®ã‚ˆã†ãªä¾‹ãŒè¼‰ã£ã¦ã„ã¾ã™ã€‚

```ruby:config/deploy.rb
set :rbenv_prefix, "RBENV_ROOT=#{fetch(:rbenv_path)} RBENV_VERSION=#{fetch(:rbenv_ruby)} #{fetch(:rbenv_path)}/bin/rbenv exec"
```

ã“ã“ã§ã¯ `rbenv_path` ã‚„ `rbenv_ruby` ã‚’ä½¿ã£ã¦ rbenv ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
README ã«è¼‰ã£ã¦ã„ã‚‹å®šç¾©é€šã‚Šã«å€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚Œã°å•é¡Œãªãå‹•ä½œã—ã¾ã™ãŒ...
ä½•ã‹ã®æ‹å­ï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€éƒ¨ã‚’åˆ‡ã‚Šå‡ºã—ãŸãªã©ï¼‰ã« `rbenv_ruby` ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒ `rbenv_prefix` ã‚ˆã‚Šã‚‚é…ããªã£ã¦ã—ã¾ã£ãŸé€”ç«¯ã«å‹•ã‹ãªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ã“ã†ã—ãŸä¸å…·åˆã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€é †ç•ªã«ä¾å­˜ã—ãªã„ã‚³ãƒ¼ãƒ‰ã«ã—ãŸã„å ´åˆã¯æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«ã—ã¾ã—ã‚‡ã†ã€‚

```ruby
set :rbenv_prefix, -> { "RBENV_ROOT=#{fetch(:rbenv_path)} RBENV_VERSION=#{fetch(:rbenv_ruby)} #{fetch(:rbenv_path)}/bin/rbenv exec" }
```

ï¼ˆãŠã¾ã‘ï¼‰Capistrano ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½ã£ã¦ã¿ã‚‹
----

Capistrano ã® `#set` ã¯ [`Capistrano::Configuration::Variables`](https://github.com/capistrano/capistrano/blob/master/lib/capistrano/configuration/variables.rb#L37-L43) ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚
è¦ã¯ãƒãƒƒã‚·ãƒ¥ã§ã‚ã‚‹ `values` ã® `key` ã«æ¸¡ã•ã‚ŒãŸ `value` ã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

```ruby:lib/capistrano/configuration/variables.rb
def set(key, value=nil, &block)
  @trusted_keys << key if trusted? && !@trusted_keys.include?(key)
  remember_location(key)
  values[key] = block || value
  trace_set(key)
  values[key]
end
```

`#fetch` ã®å®šç¾©ã¯ [ã“ã¡ã‚‰](https://github.com/capistrano/capistrano/blob/master/lib/capistrano/configuration/variables.rb#L45-L48) ã€‚
Internal use only ãª `#peek` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã¸ã¨å‡¦ç†ãŒç§»è­²ã•ã‚Œã¦ã„ã¾ã™ã€‚

```ruby:lib/capistrano/configuration/variables.rb
def fetch(key, default=nil, &block)
  fetched_keys << key unless fetched_keys.include?(key)
  peek(key, default, &block)
end
```

ãã—ã¦ `#peek` ã®å®šç¾©ã¯ [ã“ã¡ã‚‰](https://github.com/capistrano/capistrano/blob/master/lib/capistrano/configuration/variables.rb#L50-L57) ã€‚
`value` ãŒ `#callable_without_parameters?` ãªå€¤ã®ã¨ãã¯ `#call` ã‚’å‘¼ã‚“ã§ã€ãã®å€¤ã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ã¾ã™ã€‚

```ruby:lib/capistrano/configuration/variables.rb
# Internal use only.
def peek(key, default=nil, &block)
  value = fetch_for(key, default, &block)
  while callable_without_parameters?(value)
    value = (values[key] = value.call)
  end
  value
end
```

ã™ãªã‚ã¡

* `#set` ã§ã‚»ãƒƒãƒˆã•ã‚ŒãŸå€¤ãŒ `#callable_without_parameters?` ãªã¨ãã¯ `#fetch` ã•ã‚ŒãŸã¨ãã« `#call` ã•ã‚ŒãŸå€¤ãŒè¿”ã‚‹
* `#set` ã§ã‚»ãƒƒãƒˆã•ã‚ŒãŸå€¤ãŒ `#callable_without_parameters?` ã§ã¯ãªã„ã¨ãã¯ãã®å€¤ã‚’ãã®ã¾ã¾è¿”ã™

ã¨ã„ã†æŒ™å‹•ã«ãªã‚Šã¾ã™ã€‚

ã¡ãªã¿ã« `#callable_without_parameters?` ã¯[ã€Œ`#call` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ && å¼•æ•°ãŒ0å€‹ã€ã¨ã„ã†åˆ¤å®šã‚’ã—ã¦ã„ã¾ã™ã€‚](https://github.com/capistrano/capistrano/blob/d3699679b01392e26f5ba214b01bd5ee4729c3ec/lib/capistrano/proc_helpers.rb#L5-L11)
ï¼ˆ`Method#arity` ãªã‚“ã¦ã“ã®ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã—ã¦ã„ãŸã¨ãã«åˆã‚ã¦ã¿ã¾ã—ãŸ... ğŸ‘€ ï¼‰

è‡ªä½œã® Class ã‚’ä½œã£ã¦ `#call` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚Œã° `#callable_without_parameters?` ã«å½“ã¦ã¯ã¾ã‚Šã¾ã™ã€‚
ã—ã‹ã—ã“ã®ç”¨é€”ã§ã¯ã»ã¨ã‚“ã©ã®å ´åˆ Proc ã‚’ä½¿ã†ã ã‚ã†ã“ã¨ã‚’è¸ã¾ãˆã¦ã€å†’é ­ã‹ã‚‰ Proc ã«é™ã£ãŸè©±ã«ã—ã¦ã„ã¾ã—ãŸã€‚
